{"version":3,"file":"tenacious-fetch.js","sources":["../src/index.js","../src/retrying-fetch.js","../src/backoff.js"],"sourcesContent":["/* global AbortController */\nimport 'abortcontroller-polyfill/dist/abortcontroller-polyfill-only'\nimport { fetch } from 'whatwg-fetch'\nimport retryingFetch from './retrying-fetch'\n\nlet browserFetch = false\n\nif (window && window.fetch && ('signal' in new window.Request(''))) {\n  browserFetch = window.fetch\n} else {\n  browserFetch = fetch\n}\n\nfunction tenaciousFetch (url = '', config = {}) {\n  const controller = new AbortController()\n\n  config = Object.assign({\n    retries: 1,\n    retryDelay: 1000,\n    retryStatus: [],\n    retryOnFatalError: true,\n    fetcher: browserFetch,\n    signal: controller.signal,\n    timeout: undefined\n  }, config)\n\n  if (!config.fetcher || typeof config.fetcher !== 'function') {\n    throw new Error(\n      'tenacious-fetch: No fetch implementation found. Provide a valid fetch implementation via the fetcher configuration property.'\n    )\n  }\n\n  if (typeof config.retryStatus === 'string' || typeof config.retryStatus === 'number') {\n    config.retryStatus = [Number.parseInt(config.retryStatus)]\n  }\n\n  const timeout = config.timeout\n\n  if (timeout && Number.isInteger(timeout)) {\n    return Promise.race([\n      retryingFetch(config.retries, url, config),\n      new Promise((resolve, reject) =>\n        setTimeout(\n          () => {\n            controller.abort()\n            reject(\n              new Error(\n                `tenacious-fetch: Request took longer than timeout of ${timeout} ms.`\n              )\n            )\n          },\n          timeout\n        )\n      )\n    ])\n  }\n\n  return retryingFetch(config.retries, url, config)\n}\n\nexport default tenaciousFetch\n","import { linear, exponential } from './backoff'\n\nexport default function retryingFetch (retries, url, config) {\n  return new Promise((resolve, reject) => {\n    function retryAttempt (retriesLeft, url, config, value) {\n      if (retriesLeft > 0) {\n        retriesLeft--\n        const retryDelay = getRetryDelay(config, retriesLeft)\n\n        if (config.onRetry && typeof config.onRetry === 'function') {\n          config.onRetry({ retriesLeft, retryDelay, response: value })\n        }\n\n        setTimeout(() => fetchAttempt(url, config, retriesLeft), retryDelay)\n      } else {\n        reject(value)\n      }\n    }\n\n    function fetchAttempt (url, config, retriesLeft) {\n      const { retryStatus, fetcher } = config\n      fetcher(url, config)\n        .then(res => {\n          if (retryStatus.includes(res.status)) {\n            retryAttempt(retriesLeft, url, config, res)\n          } else {\n            resolve(res)\n          }\n        })\n        .catch(error => {\n          if (config.retryOnFatalError) {\n            retryAttempt(retriesLeft, url, config, error)\n          } else {\n            reject(error)\n          }\n        })\n    }\n\n    fetchAttempt(url, config, retries)\n  })\n}\n\nfunction getRetryDelay ({ retryDelay, factor, retries }, retriesLeft) {\n  if (factor && typeof factor === 'number' && Number.isInteger(factor)) {\n    return exponential(factor, retries - retriesLeft)\n  }\n  return linear(retryDelay, retries - retriesLeft)\n}\n","export const linear = (initialVal, attempt) => {\n  return initialVal * attempt\n}\n\nexport const exponential = (factor, attempt) => {\n  return Math.pow(factor, attempt)\n}\n"],"names":["browserFetch","retryingFetch","retries","url","config","Promise","resolve","reject","retryAttempt","retriesLeft","value","retryDelay","_ref","factor","Number","isInteger","attempt","Math","pow","exponential","getRetryDelay","onRetry","response","setTimeout","fetchAttempt","retryStatus","fetcher","then","res","includes","status","error","retryOnFatalError","window","fetch","Request","controller","AbortController","Object","assign","signal","timeout","undefined","Error","parseInt","race","abort"],"mappings":"2EAKgBA,4BCHD,SAAAC,EAAwBC,EAASC,EAAKC,GACnD,OAAO,IAAAC,QAAY,SAACC,EAASC,GAC3B,SAASC,EAAcC,EAAaN,EAAKC,EAAQM,GAC/C,GAAID,EAAc,EAAG,CACnBA,IACA,IAAME,EAmCd,SAAAC,EAAyDH,GAA/BE,IAAAA,IAAAA,WAAYE,EAAgCD,EAAhCC,OAAQX,EAAwBU,EAAxBV,QAC5C,OAAIW,GAA4B,iBAAXA,GAAuBC,OAAOC,UAAUF,GCvCpC,SAACA,EAAQG,GAClC,OAAOC,KAAKC,IAAIL,EAAQG,GDuCfG,CAAYN,EAAQX,EAAUO,GAEzBE,GAAYT,EAAUO,GAvCXW,CAAchB,EAAQK,GAErCL,EAAOiB,SAAqC,mBAAnBjB,EAAOiB,SAClCjB,EAAOiB,QAAQ,CAAEZ,YAAAA,EAAaE,WAAAA,EAAYW,SAAUZ,IAGtDa,WAAW,WAAMC,OAAAA,EAAarB,EAAKC,EAAQK,IAAcE,QAEzDJ,EAAOG,GAIX,SAAAc,EAAuBrB,EAAKC,EAAQK,GAClC,IAAQgB,EAAyBrB,EAAzBqB,aACRC,EADiCtB,EAAZsB,SACbvB,EAAKC,GACVuB,KAAK,SAAAC,GACAH,EAAYI,SAASD,EAAIE,QAC3BtB,EAAaC,EAAaN,EAAKC,EAAQwB,GAEvCtB,EAAQsB,KAGL,MAAA,SAAAG,GACD3B,EAAO4B,kBACTxB,EAAaC,EAAaN,EAAKC,EAAQ2B,GAEvCxB,EAAOwB,KAKfP,EAAarB,EAAKC,EAAQF,KD9B5BF,EADEiC,QAAUA,OAAOC,OAAU,WAAgBD,IAAAA,OAAOE,QAAQ,IAC7CF,OAAOC,MAEPA,EAAAA,qBAGjB,SAAyB/B,EAAUC,QAAa,IAAvBD,IAAAA,EAAM,SAAIC,IAAAA,IAAAA,EAAS,IAC1C,IAAgBgC,EAAG,IAAIC,gBAYvB,KAVAjC,EAASkC,OAAOC,OAAO,CACrBrC,QAAS,EACTS,WAAY,IACZc,YAAa,GACbO,mBAAmB,EACnBN,QAAS1B,EACTwC,OAAQJ,EAAWI,OACnBC,aAASC,GACRtC,IAESsB,SAAqC,mBAAnBtB,EAAOsB,QACnC,MAAUiB,IAAAA,MACR,gIAI8B,iBAAjBvC,EAACqB,aAA0D,iBAAvBrB,EAAOqB,cAC1DrB,EAAOqB,YAAc,CAACX,OAAO8B,SAASxC,EAAOqB,eAG/C,IAAMgB,EAAUrC,EAAOqC,QAEvB,OAAIA,GAAW3B,OAAOC,UAAU0B,GACvBpC,QAAQwC,KAAK,CAClB5C,EAAcG,EAAOF,QAASC,EAAKC,GACnC,IAAIC,QAAQ,SAACC,EAASC,GAAV,OACAgB,WACR,WACEa,EAAWU,QACXvC,EACE,IAAIoC,MACsDF,wDAAAA,EAFtD,UAMRA,OAMYxC,EAACG,EAAOF,QAASC,EAAKC"}